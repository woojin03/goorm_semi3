{% extends "base.html" %}
{% block title %}Insights{% endblock %}

{% block content %}
<!-- ğŸ–¨ï¸ í”„ë¦°íŠ¸ ì „ìš© ìŠ¤íƒ€ì¼ -->
<style>
@media print {
  body, html {
    margin: 0;
    padding: 0;
    background: white !important;
    height: auto !important;
    overflow: visible !important;
  }

  .print-hide, aside, nav, header, input, button, .sidebar {
    display: none !important;
  }

  .grid-cols-2 {
    display: block !important;
  }

  .grid-cols-2 > div {
    page-break-inside: avoid;
    break-inside: avoid;
    margin-bottom: 24px;
  }

  canvas {
    max-width: 100% !important;
    height: auto !important;
  }
}
</style>

<!-- ì œëª© ë° ë²„íŠ¼ -->
<div class="flex justify-between items-center mb-1">
  <h2 class="text-5xl font-bold mt-10 mb-6">Insights</h2>
  <button onclick="window.print()" class="print-hide bg-blue-600 hover:bg-blue-700 text-white text-xs px-4 py-2 rounded-xl shadow-sm">
    ë¦¬í¬íŠ¸ ë‚´ë³´ë‚´ê¸°
  </button>
</div>
<div class="border-b mb-6"></div>

<!-- ì°¨íŠ¸ ì˜ì—­ -->
<div class="grid grid-cols-2 gap-6 mb-10">
  <!-- ìœ„í—˜ë„ í†µê³„ -->
  <div class="bg-white p-6 rounded-xl shadow-md break-inside-avoid">
    <h3 class="text-lg font-bold mb-2 flex items-center gap-1 relative group"><span class="text-gray-400 cursor-pointer">ğŸ“Š</span>
      <div class="absolute z-10 bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-60
                  bg-black text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100
                  transition duration-300 pointer-events-none shadow-lg">
      ìµœê·¼ 3ì¼ê°„ ë¶„ì„ ê²°ê³¼ì—ì„œ *ë“±ë¡ë˜ì§€ ì•Šì€ ë¹„ì¸ê°€ ìì‚°(IP)*ì˜ ê°œìˆ˜ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
      </div>
      Shadow IT íƒì§€ ì¶”ì´</h3>
    <canvas id="chartShadowTrend" width="400" height="220"></canvas>
  </div>

  <!-- í‰ê·  ìœ„í—˜ë„ ì¶”ì´ -->
  <div class="bg-white p-6 rounded-xl shadow-md break-inside-avoid">
    <h3 class="text-lg font-bold mb-2 flex items-center gap-1 relative group"><span class="text-gray-400 cursor-pointer">ğŸ“ˆ</span>
      <div class="absolute z-10 bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-60
                  bg-black text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100
                  transition duration-300 pointer-events-none shadow-lg">
        ê° ë‚ ì§œë³„ë¡œ ìì‚°ë“¤ì˜ ìœ„í—˜ë„ ë“±ê¸‰ì„ ì ìˆ˜í™”í•˜ì—¬ í‰ê· ì„ ë‚¸ ê°’ì…ë‹ˆë‹¤.
        ë“±ê¸‰ì€ low(1ì ), medium(2ì ), high(3ì ) ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.
      </div>
      í‰ê·  ìœ„í—˜ë„ ì¶”ì´</h3>
    <canvas id="chartAvgRisk" width="400" height="220"></canvas>
  </div>

  <!-- í¬íŠ¸ ê°œìˆ˜ ì‹œê°í™” -->
  <div class="bg-white p-6 rounded-xl shadow-md break-inside-avoid">
    <h3 class="text-lg font-bold mb-2 flex items-center gap-1 relative group"><span class="text-gray-400 cursor-pointer">ğŸ“¶</span>
      <div class="absolute z-10 bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-60
                  bg-black text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100
                  transition duration-300 pointer-events-none shadow-lg">
                  ê°€ì¥ ìµœê·¼ ë¶„ì„ì¼ ê¸°ì¤€ìœ¼ë¡œ í¬íŠ¸ê°€ ê°€ì¥ ë§ì´ ì—´ë¦° ìƒìœ„ 5ê°œ IPë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
      </div>ìµœê·¼ ì—´ë¦° í¬íŠ¸ ìˆ˜</h3>
    <canvas id="chartPortCount" width="400" height="220"></canvas>
  </div>

  <!-- ì·¨ì•½ì  ë°œìƒ -->
  <div class="bg-white p-6 rounded-xl shadow-md break-inside-avoid">
    <h3 class="text-lg font-bold mb-2 flex items-center gap-1 relative group"><span class="text-gray-400 cursor-pointer">ğŸ§¯</span>
      <div class="absolute z-10 bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-60
                  bg-black text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100
                  transition duration-300 pointer-events-none shadow-lg">
                  ì·¨ì•½ì ì´ íƒì§€ëœ ì„œë¹„ìŠ¤ëª…ë³„ ê°œìˆ˜ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
      </div>ìµœê·¼ ì·¨ì•½ì  ë°œìƒ ì„œë¹„ìŠ¤</h3>
    <canvas id="chartVulnService" width="400" height="220"></canvas>
  </div>
</div>

<!-- ì¡°ì¹˜ í•„ìš” ìì‚° -->
<div class="bg-white p-6 rounded-xl shadow-md break-inside-avoid">
  <h3 class="text-lg font-bold mb-2 flex items-center gap-1 relative group"><span class="text-gray-400 cursor-pointer">ğŸ› </span>
    <div class="absolute z-10 bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-60
                bg-black text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100
                transition duration-300 pointer-events-none shadow-lg">
                ìœ„í—˜ë„ ë“±ê¸‰ê³¼ ì·¨ì•½ì  ê°œìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°€ì¥ ìœ„í—˜í•œ ìƒìœ„ 3ê°œ ìì‚°ì…ë‹ˆë‹¤.
                <n></n>
                ìš°ì„ ì ìœ¼ë¡œ ì ê²€í•˜ê±°ë‚˜ ê²©ë¦¬í•´ì•¼ í•  ëŒ€ìƒì…ë‹ˆë‹¤.
    </div>ìµœê·¼ ì¡°ì¹˜ í•„ìš” ìì‚° Top 3</h3>
  <div id="top-assets" class="text-sm text-gray-600 space-y-2">
    <p>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  let shadowTrendChart, avgRiskChart, portCountChart, vulnServiceChart;

  async function fetchAndUpdateCharts() {
    // Shadow IT Trend
    const shadowData = await fetch('/shadow-trend').then(res => res.json());
    if (shadowTrendChart) {
      shadowTrendChart.data.labels = shadowData.map(d => d.date);
      shadowTrendChart.data.datasets[0].data = shadowData.map(d => d.shadow_count);
      shadowTrendChart.update();
    } else {
      shadowTrendChart = new Chart(document.getElementById('chartShadowTrend'), {
        type: 'line',
        data: {
          labels: shadowData.map(d => d.date),
          datasets: [{ label: 'Shadow IT', data: shadowData.map(d => d.shadow_count), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.3 }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }

    // í‰ê·  ìœ„í—˜ë„ ì¶”ì´
    const riskData = await fetch('/risk-trend').then(res => res.json());
    if (avgRiskChart) {
      avgRiskChart.data.labels = riskData.map(d => d.date);
      avgRiskChart.data.datasets[0].data = riskData.map(d => d.avg_risk);
      avgRiskChart.update();
    } else {
      avgRiskChart = new Chart(document.getElementById('chartAvgRisk'), {
        type: 'line',
        data: {
          labels: riskData.map(d => d.date),
          datasets: [{ label: 'í‰ê·  ìœ„í—˜ë„', data: riskData.map(d => d.avg_risk), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.2)', tension: 0.3 }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }

    // í¬íŠ¸ ê°œìˆ˜
    const portData = await fetch('/port-count').then(res => res.json());
    if (portCountChart) {
      portCountChart.data.labels = portData.map(d => d.ip);
      portCountChart.data.datasets[0].data = portData.map(d => d.port_count);
      portCountChart.update();
    } else {
      portCountChart = new Chart(document.getElementById('chartPortCount'), {
        type: 'bar',
        data: {
          labels: portData.map(d => d.ip),
          datasets: [{ label: 'ì—´ë¦° í¬íŠ¸ ìˆ˜', data: portData.map(d => d.port_count), backgroundColor: ['#6366f1', '#f97316', '#10b981', '#f59e0b', '#ec4899'] }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }

    // ì·¨ì•½ ì„œë¹„ìŠ¤
    const vulnData = await fetch('/vuln-services').then(res => res.json());
    if (vulnServiceChart) {
      vulnServiceChart.data.labels = vulnData.map(d => d.service);
      vulnServiceChart.data.datasets[0].data = vulnData.map(d => d.count);
      vulnServiceChart.update();
    } else {
      vulnServiceChart = new Chart(document.getElementById('chartVulnService'), {
        type: 'doughnut',
        data: {
          labels: vulnData.map(d => d.service),
          datasets: [{ label: 'ì·¨ì•½ ì„œë¹„ìŠ¤ ìˆ˜', data: vulnData.map(d => d.count), backgroundColor: ['#f87171', '#facc15', '#34d399', '#60a5fa', '#a78bfa'] }]
        },
        options: { responsive: true, aspectRatio: 2, plugins: { legend: { position: 'bottom' } } }
      });
    }

    // Top 3 ìì‚°
    const topAssetsData = await fetch('/top-risk-assets').then(res => res.json());
    const wrapper = document.getElementById('top-assets');
    wrapper.innerHTML = "";
    topAssetsData.forEach((a, i) => {
      const el = document.createElement("p");
      el.innerHTML = `${i + 1}. <span class="font-mono font-semibold">${a.ip}</span> - ìœ„í—˜ë„ <strong>${a.risk_level}</strong>, ${a.description || "ì„¤ëª… ì—†ìŒ"}`;
      wrapper.appendChild(el);
    });
  }

  // ìµœì´ˆ ì‹¤í–‰
  fetchAndUpdateCharts();

  // ì´í›„ 30ì´ˆë§ˆë‹¤ ë°˜ë³µ
  setInterval(fetchAndUpdateCharts, 30000);
});
</script>
{% endblock %}
