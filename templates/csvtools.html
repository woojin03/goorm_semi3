{% extends "base.html" %}
{% block title %}DB csv{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-1">
  <h2 class="text-5xl font-bold mt-10 mb-6">CSV ë‚´ë³´ë‚´ê¸°</h2>
</div>

<div class="border-b mb-6"></div>

<p class="text-gray-600 mb-6 text-xs">
  * CSVë¡œ ì¶œë ¥í•˜ê³ ì í•˜ëŠ” DBì˜ ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  <strong>'CSVë¡œ ë‚´ë³´ë‚´ê¸°'</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
</p>

<!-- ë‚ ì§œ ì„ íƒ í¼ -->
<div class="flex space-x-4 mb-6">
  <input type="date" id="start-date" class="px-4 py-2 border rounded-lg shadow-sm w-60" />
  <input type="date" id="end-date" class="px-4 py-2 border rounded-lg shadow-sm w-60" />
</div>

<!-- ë¯¸ë¦¬ë³´ê¸° ë°•ìŠ¤ -->
<div class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200 mb-6">
  <h3 class="text-sm font-semibold text-gray-800 mb-2">
    ğŸ“„ CSVë¡œ ë‚´ë³´ë‚´ê¸°ë  DBì˜ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°
  </h3>
  <pre id="preview-box" class="text-xs text-gray-700 overflow-x-auto whitespace-pre-wrap">ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ì´ê³³ì— ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</pre>
</div>

<!-- ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ -->
<button id="export-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-base py-3 rounded-xl font-semibold disabled:opacity-50" disabled>
  CSVë¡œ ë‚´ë³´ë‚´ê¸°
</button>
{% endblock %}

{% block scripts %}
<script>
  const startInput = document.getElementById("start-date");
  const endInput = document.getElementById("end-date");
  const previewBox = document.getElementById("preview-box");
  const exportBtn = document.getElementById("export-btn");

  function updatePreview() {
    const start = startInput.value;
    const end = endInput.value;

    if (start && end) {
      fetch(`/preview-csv?start_date=${start}&end_date=${end}`)
        .then(res => res.json())
        .then(data => {
          previewBox.textContent = JSON.stringify(data, null, 2);
          exportBtn.disabled = false;
        })
        .catch(() => {
          previewBox.textContent = "ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
          exportBtn.disabled = true;
        });
    } else {
      previewBox.textContent = "ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ì´ê³³ì— ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.";
      exportBtn.disabled = true;
    }
  }

  startInput.addEventListener("change", updatePreview);
  endInput.addEventListener("change", updatePreview);


  // 30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
  setInterval(updatePreview, 30000);

  exportBtn.addEventListener("click", () => {
    const start = startInput.value;
    const end = endInput.value;
    if (start && end) {
      window.location.href = `/download-csv?start_date=${start}&end_date=${end}`;
    }
  });
</script>
{% endblock %}
