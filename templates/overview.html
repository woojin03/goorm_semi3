{% extends "base.html" %}

{% block title %}Overview{% endblock %}

{% block content %}
<!-- ìƒë‹¨ ê²€ìƒ‰/í•„í„°ë°” -->
<div class="flex items-center justify-between mb-6">
  <div class="flex space-x-6 mb-6">
    <input type="text" id="search-input" placeholder="IP ì£¼ì†Œ ê²€ìƒ‰" class="px-4 py-1 border rounded-lg w-96 shadow-sm" />
    <input type="date" id="date-filter" class="px-4 py-1 border rounded-lg w-60 shadow-sm" />
  </div>
</div>


<!-- ì œëª© -->
<h2 class="text-5xl font-bold mt-10 mb-10">ë‚´ë¶€ ìœ„í—˜ë„ ìì‚°</h2>

<!-- íƒ­ -->
<div class="flex justify-between border-b mb-6 items-center">
  <!-- ì •ë ¬ íƒ­ ë²„íŠ¼ë“¤ì— data-sort ì†ì„± ì¶”ê°€ -->
  <div class="flex space-x-10">
    <button data-sort="latest" class="sort-btn pb-2 border-b-2 border-blue-600 font-semibold text-blue-600">ìµœì‹ ìˆœ</button>
    <button data-sort="oldest" class="sort-btn pb-2 text-gray-400 hover:text-blue-500">ì˜¤ë˜ëœ ìˆœ</button>
    <button data-sort="risk" class="sort-btn pb-2 text-gray-400 hover:text-blue-500">ìœ„í—˜ë„ ë“±ê¸‰ìˆœ</button>
  </div>

  <p class="text-xs text-gray-500">
    â€» <span class="text-xs text-green-600 font-semibold">Shadow IT</span>ê°€
    <span class="text-xs text-green-600 font-semibold">O</span>ì¸ ìì‚°ì€ ë¬¸ì„œí™”ë˜ì§€ ì•Šì€ ì¥ë¹„ì…ë‹ˆë‹¤.
  </p>
</div>

<!-- ìì‚° ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ê°€ ì‚½ì…ë  ì˜ì—­ -->
<div id="card-container" class="space-y-8"></div>

<!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
<div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-xl relative">
    <button onclick="closeDetailModal()" class="absolute top-4 right-4 text-gray-500">âœ•</button>
    <div class="text-center mb-10">
      <h3 id="modal-ip" class="text-xl font-bold mb-1 font-mono">192.168.x.x</h3>
      <p id="modal-date" class="text-sm text-gray-400 mb-4">2025-04-01</p>
    </div>
    <div id="modal-body" class="space-y-3 text-sm text-gray-800">
      <!-- APIë¡œ ë°›ì•„ì˜¨ ë‚´ìš© ì‚½ì… -->
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}

<script>
let originalData = [];
let currentSort = "latest";

// ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
document.getElementById("search-input").addEventListener("input", fetchOverviewAssets);
document.getElementById("date-filter").addEventListener("change", fetchOverviewAssets);
document.querySelectorAll(".sort-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    currentSort = btn.getAttribute("data-sort");
    updateSortButtonUI(currentSort);
    fetchOverviewAssets();
  });
});

// ìœ„í—˜ë„ ìš°ì„ ìˆœìœ„ (ì •ë ¬ìš©)
const levelPriority = { "high": 3, "medium": 2, "low": 1, "ë¯¸ì •": 0 };

async function fetchOverviewAssets() {
  const res = await fetch("/overview-assets");
  const data = await res.json();
  originalData = data;
  const filtered = applyFilters(data);
  renderCards(filtered);
}

function applyFilters(data) {
  const keyword = document.getElementById("search-input").value.toLowerCase();
  const date = document.getElementById("date-filter").value;

  return data
    .filter(group => !date || group.date === date)
    .map(group => {
      const assets = group.assets.filter(a => a.ip.toLowerCase().includes(keyword));
      return { ...group, assets };
    })
    .filter(group => group.assets.length > 0);
}

function renderCards(data) {
  const container = document.getElementById("card-container");
  container.innerHTML = "";

  // ë‚ ì§œ ê·¸ë£¹ ì •ë ¬
  if (currentSort === "oldest") {
    data.sort((a, b) => a.date.localeCompare(b.date));
  } else if (currentSort === "latest") {
    data.sort((a, b) => b.date.localeCompare(a.date));
  }

  data.forEach(group => {
    const dateWrapper = document.createElement("div");
    dateWrapper.className = "bg-gray-100 px-6 pt-6 pb-3 rounded-t-2xl shadow";

    const dateTitle = document.createElement("h3");
    dateTitle.className = "text-lg font-semibold mb-4";
    dateTitle.textContent = group.date;
    dateWrapper.appendChild(dateTitle);

    const listWrapper = document.createElement("div");
    listWrapper.className = "space-y-4";

    const riskColorClass = {
      high: "text-red-500",
      medium: "text-yellow-500",
      low: "text-green-600",
      "ë¯¸ì •": "text-gray-400"
    };

    // asset ì •ë ¬ (ìœ„í—˜ë„ ë“±ê¸‰ ìˆœ)
    const sortedAssets = currentSort === "risk"
      ? [...group.assets].sort((a, b) => levelPriority[b.risk_level] - levelPriority[a.risk_level])
      : group.assets;

    sortedAssets.forEach(asset => {
      const riskLevel = (asset.risk_level || "ë¯¸ì •").toLowerCase();
      const riskClass = riskColorClass[riskLevel] || "text-gray-400";

      const card = document.createElement("div");
      card.className = "bg-white p-6 rounded-xl shadow-md flex justify-between items-center";

      card.innerHTML = `
        <div class="flex gap-14">
          <div class="w-40">
            <p class="font-semibold font-mono">${asset.ip}</p>
            <p class="text-xs text-gray-400 mt-3">IP ì£¼ì†Œ</p>
          </div>
          <div class="w-36">
            <p class="font-semibold font-mono">${asset.port_count}ê°œ</p>
            <p class="text-xs text-gray-400 mt-3">ì—´ë¦°í¬íŠ¸ ê°œìˆ˜</p>
          </div>
          <div class="w-36">
            <p class="font-semibold font-mono">${asset.vuln_count}ê°œ</p>
            <p class="text-xs text-gray-400 mt-3">ì·¨ì•½ì  ê°œìˆ˜</p>
          </div>
          <div class="w-36">
            <p class="font-semibold font-mono capitalize ${riskClass}">${asset.risk_level || 'ë¯¸ì •'}
            <p class="text-xs text-gray-400 mt-3">ìœ„í—˜ë„ ë“±ê¸‰</p>
          </div>
          <div class="w-36">
            <p class="${asset.is_shadow_it ? 'text-green-500' : 'text-gray-400'} font-semibold">
              ${asset.is_shadow_it ? 'O' : 'X'}
            </p>
            <p class="text-xs text-gray-400 mt-3">Shadow IT</p>
          </div>
        </div>
        <div class="relative">
          <button onclick="openDetailModal('${asset.ip}', '${asset.scan_date}')" class="px-4 py-2 bg-gray-100 rounded-lg shadow text-sm">ìƒì„¸ë³´ê¸°</button>
        </div>
      `;
      listWrapper.appendChild(card);
    });

    dateWrapper.appendChild(listWrapper);
    container.appendChild(dateWrapper);
  });
}

function updateSortButtonUI(activeSort) {
  document.querySelectorAll(".sort-btn").forEach(btn => {
    const sort = btn.getAttribute("data-sort");
    if (sort === activeSort) {
      btn.classList.add("border-b-2", "border-blue-600", "font-semibold", "text-blue-600");
      btn.classList.remove("text-gray-400");
    } else {
      btn.classList.remove("border-b-2", "border-blue-600", "font-semibold", "text-blue-600");
      btn.classList.add("text-gray-400");
    }
  });
}

async function openDetailModal(ip, scan_date) {
  const res = await fetch(`/asset-detail?ip=${ip}&scan_date=${scan_date}`);
  const data = await res.json();

  document.getElementById("modal-ip").textContent = ip;
  document.getElementById("modal-date").textContent = scan_date.slice(0, 10);

  const body = document.getElementById("modal-body");
  body.innerHTML = "";

  // ì—´ë¦° í¬íŠ¸ ì„¹ì…˜
  if (data.open_ports && data.open_ports.length > 0) {
    body.innerHTML += `<h4 class="font-semibold mb-2 text-xs">ğŸ›  ì—´ë¦° í¬íŠ¸</h4>`;
    data.open_ports.forEach(port => {
      const portText = `${port.port} (${port.service || "ì„œë¹„ìŠ¤ ë¯¸ìƒ"} ${port.version || ""})`;
      body.innerHTML += `
        <div class="mb-2 pl-4 border-l-2 border-gray-300">
          <div class="text-xs">í¬íŠ¸: ${portText}</div>
      `;

      if (port.cves && port.cves.length > 0) {
        body.innerHTML += `<div class="text-xs text-red-600 mt-1 font-semibold">ì·¨ì•½ì :</div>`;
        port.cves.forEach(cve => {
          body.innerHTML += `
            <div class="ml-4 text-xs text-gray-700">
              ğŸ”¸ ${cve.id} - ${cve.description}
              <br>
              <span class="text-xs text-gray-500">ëŒ€ì‘ë°©ì•ˆ: ${cve.mitigation || "ì—†ìŒ"}</span><br>
            </div>
          `;
        });
      }

      body.innerHTML += `</div>`; // í¬íŠ¸ í•­ëª© ë‹«ê¸°
    });
  }

  // ìœ„í—˜ë„
  body.innerHTML += `
    <hr class="my-4">
    <div class = "text-xs">ğŸ“Š <strong>ìœ„í—˜ë„ ë“±ê¸‰</strong>: ${data.risk_level}</div>
  `;

  // Shadow IT ê²½ê³ 
  if (data.is_shadow_it) {
    body.innerHTML += `
      <div class="mt-4 bg-yellow-100 border border-yellow-300 text-yellow-800 p-3 rounded text-xs">
        âš ï¸ ì´ ìì‚°ì€ <strong>Shadow IT</strong>ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.
      </div>
    `;
  }
  
  document.getElementById("detail-modal").classList.remove("hidden");
  document.getElementById("detail-modal").classList.add("flex");
}

function closeDetailModal() {
  const modal = document.getElementById("detail-modal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}


// ì´ˆê¸° ì‹¤í–‰
fetchOverviewAssets();

// 30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
setInterval(fetchOverviewAssets, 30000);
</script>
{% endblock %}
