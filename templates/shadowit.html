{% extends "base.html" %}
{% block title %}Shadow IT{% endblock %}

{% block content %}
<!-- Shadow IT íƒì§€ í˜ì´ì§€ ìƒë‹¨ í•„í„°/ê²€ìƒ‰-->
<div class="flex items-center justify-between mb-6">
  <div class="flex space-x-6 mb-6">
    <input id="search-input" type="text" placeholder="IP ì£¼ì†Œ ê²€ìƒ‰" class="px-4 py-1 border rounded-lg w-96 shadow-sm" />
    <input id="date-input" type="date" class="px-4 py-1 border rounded-lg w-60 shadow-sm" />
  </div>
</div>

<div class="flex justify-between items-end border-b mb-6">
  <h2 class="text-5xl font-bold mt-10 mb-6">Shadow IT íƒì§€ ëª©ë¡</h2>
  <p class="text-xs text-gray-500 mb-3">â€» ë¬¸ì„œí™”ë˜ì§€ ì•Šì€ ë³´ì•ˆ ìì‚°ì€ ë³´ì•ˆ ì ê²€ ëŒ€ìƒì…ë‹ˆë‹¤.</p>
</div>

<!-- ì¹´ë“œ ì»¨í…Œì´ë„ˆ -->
<div id="shadow-container" class="space-y-4"></div>
{% endblock %}

{% block scripts %}
<script>
let originalData = []; // âœ… ì „ì²´ ì›ë³¸ ë°ì´í„°ë¥¼ ì „ì—­ ì €ì¥

// ğŸ”„ ì„œë²„ì—ì„œ ìì‚° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
async function fetchShadowAssets() {
  const res = await fetch("/shadow-assets");
  const data = await res.json();
  originalData = data.filter(asset => !asset.is_registered); // âœ… ë“±ë¡ëœ ìì‚° ì œê±° // âœ… í•„í„°ë¥¼ ìœ„í•œ ì›ë³¸ ì €ì¥
  applyFilters();       // âœ… í•„í„° ì ìš©ëœ ìƒíƒœë¡œ ë Œë”ë§
}

// ğŸ§® ìœ„í—˜ë„ ê°œìˆ˜ ê³„ì‚° í•¨ìˆ˜
function countVulns(asset) {
  return asset.open_ports?.reduce((acc, port) => acc + (port.cves?.length || 0), 0) || 0;
}

// ğŸ¯ í•„í„° ì ìš© í•¨ìˆ˜ (ê²€ìƒ‰ + ë‚ ì§œ)
function applyFilters() {
  const keyword = document.getElementById("search-input").value.toLowerCase();
  const date = document.getElementById("date-input").value;

  const filtered = originalData.filter(asset => {
    const ipMatch = asset.ip?.toLowerCase().includes(keyword);
    const scanDate = asset.scan_date?.slice(0, 10); // ISO ë‚ ì§œ ìë¥´ê¸°
    const dateMatch = !date || scanDate === date;
    return ipMatch && dateMatch;
  });

  renderShadowCards(filtered);
}

// ğŸ§© ì¹´ë“œ ë Œë”ë§
function renderShadowCards(data) {
  const container = document.getElementById("shadow-container");
  container.innerHTML = "";

  data.forEach(asset => {
    const scanDate = asset.scan_date?.slice(0, 10) || "-";
    const ports = asset.open_ports || [];

    ports.forEach(port => {
      console.log(`[DEBUG] IP: ${asset.ip}, PORT: ${port.port}, SERVICE: ${port.service}`);
      const card = document.createElement("div");
      card.className = "bg-gray-50 p-4 rounded-xl shadow-sm flex justify-between items-center";

      card.innerHTML = `
        <div class="w-36"><p class="font-semibold font-mono">${asset.ip}</p><p class="text-xs text-gray-500 mt-2">IP ì£¼ì†Œ</p></div>
        <div class="w-36"><p class="font-semibold font-mono">${port.port || "-"}</p><p class="text-xs text-gray-500 mt-2">í¬íŠ¸</p></div>
        <div class="w-36"><p class="font-semibold font-mono">${port.service || "-"}</p><p class="text-xs text-gray-500 mt-2">ì„œë¹„ìŠ¤</p></div>
        <div class="w-36"><p class="text-red-500 font-semibold font-mono">ë¯¸ë“±ë¡</p><p class="text-xs text-gray-500 mt-2">ë“±ë¡ì—¬ë¶€</p></div>
        <div class="w-36">
          <p class="${(port.cves?.length || 0) > 0 ? 'text-red-500' : 'text-blue-600'} font-semibold font-mono">
            ${(port.cves?.length || 0) > 0 ? "ì¡°ì‚¬í•„ìš”" : "í™•ì¸ìš”ë§"}
          </p>
          <p class="text-xs text-gray-500 mt-2">ì¡°ì¹˜í•„ìš”</p>
        </div>
        <div class="w-36"><p class="font-semibold text-gray-800 font-mono">${scanDate}</p><p class="text-xs text-gray-500 mt-2">ë¶„ì„ì¼ì</p></div>
      `;
      container.appendChild(card);
    });
  });
}


// ğŸ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener("DOMContentLoaded", () => {
  fetchShadowAssets();

  document.getElementById("search-input").addEventListener("input", applyFilters);
  document.getElementById("date-input").addEventListener("change", applyFilters);

  setInterval(fetchShadowAssets, 30000);  // ì´í›„ 30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
});
</script>
{% endblock %}